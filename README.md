# Парсер Alkoteka на Scrapy

Небольшой, но по-взрослому сделанный Scrapy-проект для тестового задания:

- берёт товары из 3+ категорий `alkoteka.com` через их публичное API
  (без Playwright/Selenium и попыток парсить ленивый DOM);
- всегда учитывает регион (город) через `city_uuid` — по умолчанию Краснодар;
- жёстко следует требуемой JSON-схеме, заполняя все поля безопасными
  дефолтами, даже если часть данных не нашлась;
- даёт удобную параметризацию по городам, файлам категорий и лимиту товаров
  через CLI и `config.ini`, без правок кода;
- умеет работать через прокси и содержит простой скрипт для быстрой проверки
  результата.

## Требования
- Python 3.10+
- Scrapy 2.11+

## Установка

Все команды ниже выполняются из корня проекта.

1.  **Создать и активировать виртуальное окружение:**

    ```bash
    python3 -m venv .venv
    source .venv/bin/activate
    ```

2.  **Установить зависимости:**

    ```bash
    pip install -r requirements.txt
    ```

3.  **(Опционально) Установить pre-commit хуки:**

    ```bash
    pre-commit install
    ```

## Конфигурация

Паук настраивается через `config.ini` и аргументы командной строки Scrapy.

### `config.ini`
Основные настройки хранятся в `config.ini`. Здесь задаётся файл категорий,
город по умолчанию и список доступных городов/UUID.

```ini
[spider]
base_url = https://alkoteka.com
categories_file = categories.txt
default_city = krasnodar

[cities]
krasnodar = 4a70f9e0-46ae-11e7-83ff-00155d026416
sochi = 985b3eea-46b4-11e7-83ff-00155d026416
```

### Формат файла категорий
Файл категорий (по умолчанию `categories.txt`) должен содержать по одному URL
или пути на строку.
- **Полный URL:** `https://alkoteka.com/catalog/vino`
- **Относительный путь:** `/catalog/vino` (будет склеен с `base_url`)

Пример:
```text
https://alkoteka.com/catalog/krepkiy-alkogol
/catalog/vino
/catalog/shampanskoe-i-igristye-vina
```

## Запуск паука

### 1. Базовый запуск
Базовый сценарий: паук читает категории из `categories.txt`, использует город
по умолчанию (Краснодар) и ограничивает число товаров на категорию разумным
значением.
```bash
scrapy crawl alkoteka -O result.json
```

### 2. Лимит количества товаров
Чтобы получить меньше или больше товаров на категорию, используйте аргумент
`max_items`.
*Важно: лимит задаётся **на каждую категорию**.*

**Например, только 10 товаров на категорию:**
```bash
scrapy crawl alkoteka -a max_items=10 -O result.json
```

**Например, до 500 товаров на категорию:**
```bash
scrapy crawl alkoteka -a max_items=500 -O result.json
```

### 3. Другие настройки (город, файл категорий)
Аргументы можно свободно комбинировать.

**Выбрать конкретный город:**
```bash
scrapy crawl alkoteka -a city=sochi -O result.json
```

**Использовать другой файл категорий:**
```bash
scrapy crawl alkoteka -a categories=my_custom_list.txt -O result.json
```

**Комбинированный пример (50 товаров, город Сочи, свой файл категорий):**
```bash
scrapy crawl alkoteka -a city=sochi -a categories=my_custom_list.txt -a max_items=50 -O result.json
```

## Управление городами
Чтобы использовать другой город по умолчанию:
1. Найдите UUID города (например, в параметре `city_uuid` в запросах сайта).
2. Добавьте его в секцию `[cities]` в `config.ini`.
3. Задайте нужный ключ в `default_city` в секции `[spider]`.

Также город можно передать при запуске через `-a city=...`.

## Проверка результата

### 1. Вспомогательный скрипт `sanity_check.py`
Для быстрой проверки структуры `result.json` и минимальной валидации схемы
можно использовать скрипт:

```bash
python3 sanity_check.py
```

Или указать другой файл:
```bash
python3 sanity_check.py my_results.json
```

Скрипт:
- проверяет, что файл существует и содержит валидный JSON;
- убеждается, что корневой объект — список, и выводит количество элементов;
- проверяет, что у первого товара есть все обязательные ключи верхнего уровня;
- дополнительно валидирует вложенные структуры `price_data`, `stock` и
  наличие `metadata.__description`.

### 2. Быстрый ручной просмотр JSON
Чтобы быстро посмотреть начало файла в читабельном виде:

```bash
python3 -m json.tool result.json | head
```

Или получить базовую статистику и первый товар:

```bash
python3 - << 'PY'
import json
from pathlib import Path

data = json.loads(Path("result.json").read_text(encoding="utf-8"))
print("Total products:", len(data))
print("First product:", data[0] if data else None)
PY
```

## Поддержка прокси

Прокси настраиваются через `proxies.txt` в корне проекта и middleware
`ProxyMiddleware`.

- Одна строка — один прокси URL, например:

  ```text
  # HTTP-прокси
  http://user:pass@host1:port1
  http://host2:port2
  ```

- Пустые строки и строки, начинающиеся с `#`, игнорируются.
- Если `proxies.txt` отсутствует или пуст, паук работает без прокси.

Простейший способ проверить, что прокси реально используется — указать
заведомо нерабочий прокси (например, `http://127.0.0.1:9999`) и запустить
паук: ошибки подключения в логах будут означать, что запросы идут через
прокси.

## Примечания
- Регион (город) управляется через `config.ini` / `-a city=...` и далее
  передаётся в API как `city_uuid`, поэтому данные всегда собираются для
  нужного региона (по умолчанию — Краснодар).
